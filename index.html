<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>CatKitSune ‚Äì Quests & Swap</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<!-- üî• MINT TAB STYLING - RED VERSION -->
<style>
.top-nav-btn.mint-tab {
  background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
  color: white !important;
  border: 1px solid #ef4444 !important;
  font-weight: 700;
  box-shadow: 0 2px 8px rgba(239, 68, 68, 0.25);
  transition: all 0.3s ease;
}

.top-nav-btn.mint-tab:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
}

@keyframes subtle-pulse-red {
  0%, 100% {
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.25);
  }
  50% {
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.45);
  }
}

.top-nav-btn.mint-tab {
  animation: subtle-pulse-red 2s ease-in-out infinite;
}

/* Staking Slot Styles */
.staking-slot {
  transition: all 0.3s ease !important;
}

.staking-slot:hover {
  transform: translateY(-4px);
  box-shadow: 0 4px 12px rgba(20, 184, 166, 0.2);
}

/* üé® NFT Selection Modal */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  backdrop-filter: blur(4px);
}

.modal-overlay.active {
  display: flex;
}

.modal-content {
  background: white;
  border-radius: 24px;
  padding: 24px;
  max-width: 600px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: modalSlideIn 0.3s ease;
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 2px solid #f3f4f6;
}

.modal-title {
  font-size: 20px;
  font-weight: 800;
  color: var(--primary);
}

.modal-close {
  background: #f3f4f6;
  border: none;
  border-radius: 50%;
  width: 32px;
  height: 32px;
  cursor: pointer;
  font-size: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.modal-close:hover {
  background: #ef4444;
  color: white;
  transform: rotate(90deg);
}

.nft-selection-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 16px;
  margin-top: 16px;
}

.nft-select-card {
  background: white;
  border: 2px solid #e5e7eb;
  border-radius: 16px;
  padding: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  text-align: center;
}

.nft-select-card:hover {
  border-color: var(--primary);
  transform: translateY(-4px);
  box-shadow: 0 8px 24px rgba(20, 184, 166, 0.2);
}

.nft-select-card.selected {
  border-color: var(--primary);
  background: linear-gradient(135deg, rgba(20, 184, 166, 0.1), rgba(139, 92, 246, 0.1));
  box-shadow: 0 4px 16px rgba(20, 184, 166, 0.3);
}

.nft-select-img {
  width: 100%;
  height: 120px;
  object-fit: cover;
  border-radius: 12px;
  margin-bottom: 8px;
  background: linear-gradient(135deg, #f0fdf9, #ccfbf1);
}

.nft-select-id {
  font-weight: 700;
  font-size: 14px;
  color: var(--text-main);
  margin-bottom: 4px;
}

.nft-select-series {
  font-size: 11px;
  color: var(--text-muted);
}

.modal-footer {
  margin-top: 20px;
  padding-top: 16px;
  border-top: 2px solid #f3f4f6;
  display: flex;
  gap: 12px;
}

.modal-btn {
  flex: 1;
  padding: 12px 24px;
  border-radius: 12px;
  border: none;
  font-weight: 700;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
}

.modal-btn-primary {
  background: linear-gradient(135deg, var(--primary), #8b5cf6);
  color: white;
}

.modal-btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(20, 184, 166, 0.3);
}

.modal-btn-primary:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.modal-btn-secondary {
  background: #f3f4f6;
  color: var(--text-main);
}

.modal-btn-secondary:hover {
  background: #e5e7eb;
}

.modal-empty {
  text-align: center;
  padding: 40px 20px;
  color: var(--text-muted);
}

.modal-empty-icon {
  font-size: 48px;
  margin-bottom: 16px;
}

.modal-empty-text {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 8px;
}

.modal-empty-subtext {
  font-size: 14px;
}
</style>

<style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg-main: #0a0e1a;
      --bg-card: rgba(21, 25, 37, 0.6);
      --primary: #8b5cf6;
      --primary-dark: #7c3aed;
      --primary-soft: rgba(139, 92, 246, 0.1);
      --accent-green: #00f5ff;
      --border: rgba(139, 92, 246, 0.2);
      --text-main: #ffffff;
      --text-muted: #a1a1aa;
      --radius-lg: 16px;
      --radius-xl: 20px;
      --shadow-card: 0 10px 30px rgba(139, 92, 246, 0.2);
    }

    body {
      font-family: "Inter", sans-serif;
      background: var(--bg-main);
      color: var(--text-main);
      min-height: 100vh;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: radial-gradient(ellipse at top, #1a1f3a 0%, #0a0e1a 50%);
      z-index: -2;
    }

    body::after {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-image: 
        linear-gradient(rgba(139, 92, 246, 0.1) 1px, transparent 1px),
        linear-gradient(90deg, rgba(139, 92, 246, 0.1) 1px, transparent 1px);
      background-size: 50px 50px;
      opacity: 0.3;
      z-index: -1;
      pointer-events: none;
    }

    .app { min-height: 100vh; display: flex; flex-direction: column; }

    header {
      padding: 2px 16px;
      background: rgba(10, 14, 26, 0.8);
      backdrop-filter: blur(20px);
      display: flex; align-items: center; justify-content: space-between;
      position: relative;
      z-index: 1000;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
    }
    
    .logo-icon {
      height: 80px;
      width: auto;
      object-fit: contain;
      display: block;
    }
    
    .logo-text {
      font-size: 24px;
      font-weight: 900;
      background: linear-gradient(135deg, #8b5cf6, #00f5ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .top-actions { display: flex; align-items: center; gap: 8px; }

    .login-btn {
      font-size: 12px; padding: 6px 12px; border-radius: 999px;
      border: 1px solid rgba(139, 92, 246, 0.3);
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(10px);
      color: white;
      cursor: pointer;
      display:flex;
      align-items:center;
      gap:6px;
      transition: all 0.2s;
    }

    .login-btn:hover {
      background: rgba(139, 92, 246, 0.2);
      border-color: var(--primary);
      box-shadow: 0 0 30px rgba(139, 92, 246, 0.4);
      transform: translateY(-2px);
    }

    .avatar {
      width: 26px; height: 26px; border-radius: 50%;
      background: linear-gradient(135deg, #14b8a6, #10b981);
    }

    main { flex: 1; padding: 0 12px 80px; max-width: 1200px; margin: 0 auto; width: 100%; }

    .top-nav {
      margin-top: 20px;
      margin-bottom: 20px;
      display: flex;
      justify-content: center;
      gap: 12px;
    }

    .top-nav-btn {
      padding: 4px 14px;
      font-size: 13px;
      border-radius: 999px;
      border: 1px solid rgba(139, 92, 246, 0.3);
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(10px);
      color: white;
      cursor: pointer;
      transition: 0.2s;
    }

    .top-nav-btn:hover { 
      background: rgba(139, 92, 246, 0.2);
      border-color: var(--primary);
    }

    .top-nav-btn.active {
      background: linear-gradient(135deg, var(--primary), var(--accent-green));
      color: white;
      border-color: var(--primary);
    }

.view {
  display: none;
  width: 100%;
}

.view.active {
  display: block;
}

.views-container {
  position: relative;
}

    .content-grid {
      display: flex;
      flex-direction: column;
      gap: 32px;
    }

    .card {
      background: rgba(21, 25, 37, 0.6);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      border: 1px solid rgba(139, 92, 246, 0.3);
      box-shadow: 
        0 0 60px rgba(139, 92, 246, 0.2),
        inset 0 0 60px rgba(139, 92, 246, 0.05);
      padding: 18px 16px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(20, 184, 166, 0.05), rgba(16, 185, 129, 0.05));
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 0;
      pointer-events: none;
    }

    .card:hover::before {
      opacity: 1;
    }

    .card > * {
      position: relative;
      z-index: 1;
    }

    .card:hover {
      box-shadow: 0 12px 40px rgba(20, 184, 166, 0.15);
      transform: translateY(-2px);
      border-color: var(--primary-soft);
    }

    .card-title {
      font-size: 14px; font-weight: 700; margin-bottom: 12px;
      display: flex; align-items: center; gap: 8px;
    }

    .card-title span.dot {
      width: 6px; height: 6px; border-radius: 999px; background: var(--primary);
    }

    .nft-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 12px;
      margin-top: 10px;
    }

    .nft-card {
      border-radius: 10px;
      border: 1px dashed rgba(139, 92, 246, 0.3);
      background: rgba(255,255,255,0.03);
      padding: 14px 8px;
      text-align: center;
      font-size: 11px;
      color: var(--text-muted);
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 120px;
    }

    .nft-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(106, 61, 245, 0.1), rgba(34, 197, 94, 0.1));
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 0;
    }

    .nft-card:hover {
      transform: translateY(-4px);
      border-color: var(--primary);
      border-style: solid;
      background: rgba(139, 92, 246, 0.1);
      box-shadow: 0 8px 24px rgba(139, 92, 246, 0.4);
    }

    .nft-card:hover::before {
      opacity: 1;
    }

    .nft-card strong {
      display: block;
      font-size: 10.5px;
      color: var(--text-main);
      font-weight: 600;
      position: relative;
      z-index: 1;
      line-height: 1.3;
      word-break: break-word;
      max-width: 100%;
      text-align: center;
    }
    
    .nft-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 10px;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 0;
    }

    .nft-count {
      display: block;
      font-size: 10px;
      color: var(--text-muted);
      font-weight: 500;
      text-align: center;
      margin-top: 4px;
    }

    @media (max-width: 1024px) {
      .nft-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    @media (max-width: 768px) {
      .nft-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 480px) {
      .nft-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
  
  <script>
  // ========================================
  // EARLY FUNCTION DEFINITIONS (HEAD)
  // These ensure onclick handlers work immediately
  // ========================================
  
  window.showView = function(event, viewName) {
    try {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.querySelectorAll('.top-nav-btn').forEach(btn => btn.classList.remove('active'));
      const targetView = document.getElementById('view-' + viewName);
      if (targetView) {
        targetView.classList.add('active');
      }
      if (event && event.target) {
        event.target.classList.add('active');
      }
      window.scrollTo({ top: 0, behavior: 'smooth' });
    } catch (error) {
      console.error('showView error:', error);
    }
  };
  
  window.toggleWallet = function() {
    console.log('Wallet button clicked, initializing...');
    if (typeof connectWallet === 'function') {
      if (window.walletConnected) {
        if (confirm('Disconnect wallet?')) {
          disconnectWallet();
        }
      } else {
        connectWallet();
      }
    }
  };
  
  window.loginWithTwitter = function() {
    window.location.href = "https://catkitsune.xyz/api/twitter-login";
  };
  
  console.log('‚úÖ Early functions loaded in head');
  </script>
</head>
<body>
<div class="app">
<header>
<div class="logo" onclick="showView(event, 'quests')">
<span class="logo-text">CatKitSune</span>
</div>
<div class="top-actions">
<button class="login-btn mint-tab" onclick="window.location.href='/launch'" style="margin-right: 8px;">
üî• Mint
</button>
<button class="login-btn" id="walletBtn" onclick="toggleWallet()">
<img src="https://cdn-icons-png.flaticon.com/512/891/891462.png" style="width:18px;"/>
<span id="walletText">Connect Wallet</span>
</button>
<button class="login-btn" id="twitterBtn" onclick="loginWithTwitter()">
<img src="https://cdn-icons-png.flaticon.com/512/733/733579.png" style="width:18px;"/>
Login with Twitter
</button>
<div id="twitterAvatar" style="display:none; align-items:center; gap:6px;"></div>
<div class="avatar"></div>
</div>
</header>

<!-- üé® NFT Selection Modal -->
<div id="nftModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">ü¶ä Select NFT to Stake</h2>
      <button class="modal-close" onclick="closeNFTModal()">√ó</button>
    </div>
    
    <div id="modalNFTList">
      <!-- NFTs will be loaded here -->
    </div>
    
    <div class="modal-footer">
      <button class="modal-btn modal-btn-secondary" onclick="closeNFTModal()">Cancel</button>
      <button class="modal-btn modal-btn-primary" id="confirmStakeBtn" onclick="confirmStake()" disabled>Stake NFT</button>
    </div>
  </div>
</div>

<div class="views-container">

<main class="view active" id="view-quests">

<div class="top-nav">
<button class="top-nav-btn active" onclick="showView(event, 'quests')">üéÆ</button>
<button class="top-nav-btn" onclick="showView(event, 'roadmap')">üó∫Ô∏è</button>
<button class="top-nav-btn" onclick="showView(event, 'staking')">üíé</button>
</div>

<div class="content-grid">

<!-- NFT GALLERY - FULL WIDTH -->
<div class="card">
<div class="card-title"><span class="dot"></span> NFT Gallery</div>
<div class="nft-grid">
<div style="display:flex;flex-direction:column;align-items:center;" data-nft-index="0">
  <div class="nft-card">
    <strong>Wealthy Hypo Babies</strong>
  </div>
  <span class="nft-count" id="nft-0" style="margin-top:4px;font-size:10px;">0 owned</span>
</div>
<div style="display:flex;flex-direction:column;align-items:center;" data-nft-index="1">
  <div class="nft-card">
    <strong>Tiny Hyper Cats</strong>
  </div>
  <span class="nft-count" id="nft-1" style="margin-top:4px;font-size:10px;">0 owned</span>
</div>
<div style="display:flex;flex-direction:column;align-items:center;" data-nft-index="2">
  <div class="nft-card">
    <strong>Hypurr</strong>
  </div>
  <span class="nft-count" id="nft-2" style="margin-top:4px;font-size:10px;">0 owned</span>
</div>
<div style="display:flex;flex-direction:column;align-items:center;" data-nft-index="3">
  <div class="nft-card">
    <strong>Hyperian Genesis</strong>
  </div>
  <span class="nft-count" id="nft-3" style="margin-top:4px;font-size:10px;">0 owned</span>
</div>
<div style="display:flex;flex-direction:column;align-items:center;" data-nft-index="4">
  <div class="nft-card">
    <strong>CatKitSune</strong>
  </div>
  <span class="nft-count" id="nft-4" style="margin-top:4px;font-size:10px;">0 owned</span>
</div>
<div style="display:flex;flex-direction:column;align-items:center;" data-nft-index="5">
  <div class="nft-card">
    <strong>Illumeownati by Catbal</strong>
  </div>
  <span class="nft-count" id="nft-5" style="margin-top:4px;font-size:10px;">0 owned</span>
</div>
<div style="display:flex;flex-direction:column;align-items:center;" data-nft-index="6">
  <div class="nft-card">
    <strong>PiP & Friends</strong>
  </div>
  <span class="nft-count" id="nft-6" style="margin-top:4px;font-size:10px;">0 owned</span>
</div>
<div style="display:flex;flex-direction:column;align-items:center;" data-nft-index="7">
  <div class="nft-card">
    <strong>Hypers</strong>
  </div>
  <span class="nft-count" id="nft-7" style="margin-top:4px;font-size:10px;">0 owned</span>
</div>
<div style="display:flex;flex-direction:column;align-items:center;" data-nft-index="8">
  <div class="nft-card">
    <strong>Mechacats</strong>
  </div>
  <span class="nft-count" id="nft-8" style="margin-top:4px;font-size:10px;">0 owned</span>
</div>
<div style="display:flex;flex-direction:column;align-items:center;" data-nft-index="9">
  <div class="nft-card">
    <strong>LQnians</strong>
  </div>
  <span class="nft-count" id="nft-9" style="margin-top:4px;font-size:10px;">0 owned</span>
</div>
<div style="display:flex;flex-direction:column;align-items:center;" data-nft-index="10">
  <div class="nft-card">
    <strong>bald br√∂thers</strong>
  </div>
  <span class="nft-count" id="nft-10" style="margin-top:4px;font-size:10px;">0 owned</span>
</div>
<div style="display:flex;flex-direction:column;align-items:center;" data-nft-index="11">
  <div class="nft-card">
    <strong>BAE</strong>
  </div>
  <span class="nft-count" id="nft-11" style="margin-top:4px;font-size:10px;">0 owned</span>
</div>
<div style="display:flex;flex-direction:column;align-items:center;" data-nft-index="12">
  <div class="nft-card">
    <strong>Hypo</strong>
  </div>
  <span class="nft-count" id="nft-12" style="margin-top:4px;font-size:10px;">0 owned</span>
</div>
<div style="display:flex;flex-direction:column;align-items:center;" data-nft-index="13">
  <div class="nft-card">
    <strong>Hyperian Legacy</strong>
  </div>
  <span class="nft-count" id="nft-13" style="margin-top:4px;font-size:10px;">0 owned</span>
</div>
<div style="display:flex;flex-direction:column;align-items:center;" data-nft-index="14">
  <div class="nft-card">
    <strong>Odd Otties</strong>
  </div>
  <span class="nft-count" id="nft-14" style="margin-top:4px;font-size:10px;">0 owned</span>
</div>
<div style="display:flex;flex-direction:column;align-items:center;" data-nft-index="15">
  <div class="nft-card">
    <strong>Purrtardio</strong>
  </div>
  <span class="nft-count" id="nft-15" style="margin-top:4px;font-size:10px;">0 owned</span>
</div>
<div style="display:flex;flex-direction:column;align-items:center;" data-nft-index="16">
  <div class="nft-card">
    <strong>Gems</strong>
  </div>
  <span class="nft-count" id="nft-16" style="margin-top:4px;font-size:10px;">0 owned</span>
</div>
<div style="display:flex;flex-direction:column;align-items:center;" data-nft-index="17">
  <div class="nft-card">
    <strong>HyperPunks</strong>
  </div>
  <span class="nft-count" id="nft-17" style="margin-top:4px;font-size:10px;">0 owned</span>
</div>
<div style="display:flex;flex-direction:column;align-items:center;" data-nft-index="18">
  <div class="nft-card">
    <strong>dotHYPE</strong>
  </div>
  <span class="nft-count" id="nft-18" style="margin-top:4px;font-size:10px;">0 owned</span>
</div>
<div style="display:flex;flex-direction:column;align-items:center;" data-nft-index="19">
  <div class="nft-card">
    <strong>Dysto Mfers</strong>
  </div>
  <span class="nft-count" id="nft-19" style="margin-top:4px;font-size:10px;">0 owned</span>
</div>
</div>
</div>

</div>
</main>

<!-- ROADMAP PAGE -->
<main class="view" id="view-roadmap">

<div class="top-nav">
<button class="top-nav-btn" onclick="showView(event, 'quests')">üéÆ</button>
<button class="top-nav-btn active" onclick="showView(event, 'roadmap')">üó∫Ô∏è</button>
<button class="top-nav-btn" onclick="showView(event, 'staking')">üíé</button>
</div>

<div style="background:linear-gradient(135deg,#fee2e2,#fecaca);padding:10px 14px;border-radius:10px;margin-bottom:10px;border:1px solid #ef4444;">
<div style="font-size:12px;font-weight:700;color:#991b1b;margin-bottom:3px;text-align:center;">üöß Website Under Development</div>
<div style="font-size:10px;color:#7f1d1d;line-height:1.4;text-align:center;">
<strong>Note:</strong> Not all features on this website are fully functional yet. Some sections are still in development and will be activated progressively.
</div>
</div>

<div style="background:linear-gradient(135deg,#fef3c7,#fde68a);padding:10px 14px;border-radius:10px;margin-bottom:16px;border:1px solid #fbbf24;">
<div style="font-size:12px;font-weight:700;color:#92400e;margin-bottom:3px;text-align:center;">‚ö†Ô∏è Important: No Fixed Timeline</div>
<div style="font-size:10px;color:#78350f;line-height:1.4;text-align:center;">
This roadmap is <strong>NOT time-bound</strong>. Progress through each phase at your own pace. Complete prerequisites to unlock next stages.
</div>
</div>

<div class="content-grid">

<!-- PHASE 1: NFT Series System -->
<div class="card">
<div class="card-title"><span class="dot"></span> Phase 1: üé® NFT Series System</div>
<div style="display:flex;flex-direction:column;gap:12px;margin-top:12px;">

<div style="padding:16px;background:linear-gradient(135deg,#f0fdf9,#ccfbf1);border-radius:12px;border-left:4px solid #14b8a6;">
<div style="font-weight:700;font-size:14px;color:#115e59;margin-bottom:6px;">1Ô∏è‚É£ Series 1 NFT ‚Äì Entry Level</div>
<div style="font-size:12px;color:#334155;line-height:1.6;">
<strong>Requirement:</strong> None<br>
<strong>Unlock:</strong> Series 2 minting access<br>
<strong>Chain:</strong> Hyperliquid<br>
<strong>Marketplace:</strong> <a href="https://drip.trade/" target="_blank" style="color:#14b8a6;font-weight:600;">DripTrade</a><br>
<strong>Minting:</strong> <span style="color:#14b8a6;font-weight:600;">Coming Soon</span>
</div>
</div>

<div style="padding:16px;background:linear-gradient(135deg,#fef3c7,#fde68a);border-radius:12px;border-left:4px solid #f59e0b;">
<div style="font-weight:700;font-size:14px;color:#92400e;margin-bottom:6px;">2Ô∏è‚É£ Series 2 NFT ‚Äì Advanced Level</div>
<div style="font-size:12px;color:#334155;line-height:1.6;">
<strong>Requirement:</strong> Own Series 1 NFT<br>
<strong>Unlock:</strong> Series 3 minting access<br>
<strong>Chain:</strong> Hyperliquid<br>
<strong>Marketplace:</strong> <a href="https://drip.trade/" target="_blank" style="color:#f59e0b;font-weight:600;">DripTrade</a><br>
<strong>Minting:</strong> <span style="color:#f59e0b;font-weight:600;">Coming Soon</span>
</div>
</div>

<div style="padding:16px;background:linear-gradient(135deg,#faf5ff,#f3e8ff);border-radius:12px;border-left:4px solid #a855f7;">
<div style="font-weight:700;font-size:14px;color:#6b21a8;margin-bottom:6px;">3Ô∏è‚É£ Series 3 NFT ‚Äì Premium Level + Token Rewards</div>
<div style="font-size:12px;color:#334155;line-height:1.6;">
<strong>Requirement:</strong> Own Series 1 + Series 2 NFTs<br>
<strong>Benefits:</strong><br>
- Token rewards<br>
- Extra airdrop eligibility<br>
<strong>Chain:</strong> Hyperliquid<br>
<strong>Marketplace:</strong> <a href="https://drip.trade/" target="_blank" style="color:#a855f7;font-weight:600;">DripTrade</a><br>
<strong>Minting:</strong> <span style="color:#a855f7;font-weight:600;">Coming Soon</span>
</div>
</div>

</div>
</div>

</div>
</main>

<!-- STAKING VIEW -->
<main class="view" id="view-staking">
<div class="page-title" style="text-align:center; margin-bottom:16px;">
<h1 style="font-size:32px; font-weight:800; margin-bottom:8px;">üíé NFT Staking</h1>
<p style="font-size:14px; color:var(--text-muted); margin-bottom:16px;">Stake up to 5 NFTs from each series and earn 5 EP per NFT!</p>

<!-- Navigation Buttons -->
<div style="display:flex; gap:12px; align-items:center; justify-content:center; margin-bottom:24px;">
<button class="top-nav-btn" onclick="showView(event, 'quests')">üéÆ</button>
<button class="top-nav-btn" onclick="showView(event, 'roadmap')">üó∫Ô∏è</button>
<button class="top-nav-btn active" onclick="showView(event, 'staking')">üíé</button>
</div>
</div>

<!-- Staking Info Card -->
<div class="card" style="margin-bottom:20px; background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(236, 72, 153, 0.1)); border: 1px solid rgba(168, 85, 247, 0.3);">
<div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px;">
<h3 style="font-size:16px; font-weight:700;">üìä Your Staking Stats</h3>
<div style="display:flex; gap:16px; align-items:center;">
<div style="text-align:center;">
<div style="font-size:11px; color:var(--text-muted); margin-bottom:4px;">Staked NFTs</div>
<div id="totalStaked" style="font-size:20px; font-weight:800; color:var(--primary);">0/15</div>
</div>
<div style="text-align:center;">
<div style="font-size:11px; color:var(--text-muted); margin-bottom:4px;">Total EP Earned</div>
<div id="totalStakingEP" style="font-size:20px; font-weight:800; color:#a855f7;">0</div>
</div>
</div>
</div>
<div style="font-size:13px; color:var(--text-muted); line-height:1.6;">
üí° Stake <strong style="color:var(--primary);">up to 5 NFTs from each series</strong> to earn 5 EP per staked NFT!<br>
<span style="font-size:11px; opacity:0.8;">Contract: 0x2abF2969E5e9cAAa1D3fF3DF4265dFFcda0D8353</span>
</div>
</div>

<!-- Staking Pools by Series -->
<div style="display:grid; gap:16px;">

<!-- Series 1: NFT #1-100 -->
<div class="card staking-pool" data-series="1" style="position:relative; overflow:hidden;">
<div style="position:absolute; top:12px; right:12px; background:linear-gradient(135deg, #a855f7, #ec4899); color:white; padding:4px 12px; border-radius:999px; font-size:11px; font-weight:700;">
+25 EP Max
</div>
<div style="margin-bottom:16px;">
<h3 style="font-size:18px; font-weight:700; margin-bottom:8px; display:flex; align-items:center; gap:8px;">
<span>ü¶ä</span>
<span>Series 1 Staking</span>
<span id="series1-count" style="font-size:14px; color:var(--text-muted); font-weight:500;">(0/5)</span>
</h3>
<p style="font-size:13px; color:var(--text-muted);">Stake up to 5 NFTs from Series 1 (ID #1-100)</p>
</div>

<!-- 5 Staking Slots for Series 1 -->
<div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:12px; margin-bottom:16px;" id="series1-slots">

<!-- Slot 0 -->
<div id="series1-slot0" class="staking-slot" data-series="1" data-slot="0" style="background:white; border:2px solid var(--primary); border-radius:12px; min-height:180px; position:relative; cursor:pointer; transition:all 0.3s; overflow:hidden;" onclick="openNFTModal(1, 0)">
<img src="/launch/1.png" class="nft-slot-image" alt="CatKitSune NFT" style="width:100%; height:100%; object-fit:cover; position:absolute; top:0; left:0; opacity:0.4; transition:opacity 0.3s ease; border-radius:12px;">
<div class="slot-overlay" style="position:relative; z-index:2; display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; min-height:180px; padding:16px; background:linear-gradient(135deg, rgba(20, 184, 166, 0.05), rgba(139, 92, 246, 0.05));">
<div style="font-size:14px; color:var(--primary); font-weight:700; text-align:center; text-shadow:0 2px 4px rgba(255,255,255,0.8);">+ Add NFT</div>
<div style="font-size:11px; color:var(--text-muted); text-align:center; margin-top:4px; text-shadow:0 1px 2px rgba(255,255,255,0.8);">Click to stake</div>
</div>
</div>

<!-- Slot 1 -->
<div id="series1-slot1" class="staking-slot" data-series="1" data-slot="1" style="background:white; border:2px solid var(--primary); border-radius:12px; min-height:180px; position:relative; cursor:pointer; transition:all 0.3s; overflow:hidden;" onclick="openNFTModal(1, 1)">
<img src="/launch/2.png" class="nft-slot-image" alt="CatKitSune NFT" style="width:100%; height:100%; object-fit:cover; position:absolute; top:0; left:0; opacity:0.4; transition:opacity 0.3s ease; border-radius:12px;">
<div class="slot-overlay" style="position:relative; z-index:2; display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; min-height:180px; padding:16px; background:linear-gradient(135deg, rgba(20, 184, 166, 0.05), rgba(139, 92, 246, 0.05));">
<div style="font-size:14px; color:var(--primary); font-weight:700; text-align:center; text-shadow:0 2px 4px rgba(255,255,255,0.8);">+ Add NFT</div>
<div style="font-size:11px; color:var(--text-muted); text-align:center; margin-top:4px; text-shadow:0 1px 2px rgba(255,255,255,0.8);">Click to stake</div>
</div>
</div>

<!-- Slot 2 -->
<div id="series1-slot2" class="staking-slot" data-series="1" data-slot="2" style="background:white; border:2px solid var(--primary); border-radius:12px; min-height:180px; position:relative; cursor:pointer; transition:all 0.3s; overflow:hidden;" onclick="openNFTModal(1, 2)">
<img src="/launch/3.png" class="nft-slot-image" alt="CatKitSune NFT" style="width:100%; height:100%; object-fit:cover; position:absolute; top:0; left:0; opacity:0.4; transition:opacity 0.3s ease; border-radius:12px;">
<div class="slot-overlay" style="position:relative; z-index:2; display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; min-height:180px; padding:16px; background:linear-gradient(135deg, rgba(20, 184, 166, 0.05), rgba(139, 92, 246, 0.05));">
<div style="font-size:14px; color:var(--primary); font-weight:700; text-align:center; text-shadow:0 2px 4px rgba(255,255,255,0.8);">+ Add NFT</div>
<div style="font-size:11px; color:var(--text-muted); text-align:center; margin-top:4px; text-shadow:0 1px 2px rgba(255,255,255,0.8);">Click to stake</div>
</div>
</div>

<!-- Slot 3 -->
<div id="series1-slot3" class="staking-slot" data-series="1" data-slot="3" style="background:white; border:2px solid var(--primary); border-radius:12px; min-height:180px; position:relative; cursor:pointer; transition:all 0.3s; overflow:hidden;" onclick="openNFTModal(1, 3)">
<img src="/launch/4.png" class="nft-slot-image" alt="CatKitSune NFT" style="width:100%; height:100%; object-fit:cover; position:absolute; top:0; left:0; opacity:0.4; transition:opacity 0.3s ease; border-radius:12px;">
<div class="slot-overlay" style="position:relative; z-index:2; display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; min-height:180px; padding:16px; background:linear-gradient(135deg, rgba(20, 184, 166, 0.05), rgba(139, 92, 246, 0.05));">
<div style="font-size:14px; color:var(--primary); font-weight:700; text-align:center; text-shadow:0 2px 4px rgba(255,255,255,0.8);">+ Add NFT</div>
<div style="font-size:11px; color:var(--text-muted); text-align:center; margin-top:4px; text-shadow:0 1px 2px rgba(255,255,255,0.8);">Click to stake</div>
</div>
</div>

<!-- Slot 4 -->
<div id="series1-slot4" class="staking-slot" data-series="1" data-slot="4" style="background:white; border:2px solid var(--primary); border-radius:12px; min-height:180px; position:relative; cursor:pointer; transition:all 0.3s; overflow:hidden;" onclick="openNFTModal(1, 4)">
<img src="/launch/5.png" class="nft-slot-image" alt="CatKitSune NFT" style="width:100%; height:100%; object-fit:cover; position:absolute; top:0; left:0; opacity:0.4; transition:opacity 0.3s ease; border-radius:12px;">
<div class="slot-overlay" style="position:relative; z-index:2; display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; min-height:180px; padding:16px; background:linear-gradient(135deg, rgba(20, 184, 166, 0.05), rgba(139, 92, 246, 0.05));">
<div style="font-size:14px; color:var(--primary); font-weight:700; text-align:center; text-shadow:0 2px 4px rgba(255,255,255,0.8);">+ Add NFT</div>
<div style="font-size:11px; color:var(--text-muted); text-align:center; margin-top:4px; text-shadow:0 1px 2px rgba(255,255,255,0.8);">Click to stake</div>
</div>
</div>

</div>
</div>

</div>
</main>

</div><!-- /views-container -->

</div><!-- /app -->
<script>
// ==========================================
// FIREBASE CONFIGURATION
// ==========================================
const firebaseConfig = {
  apiKey: "AIzaSyBm9YORem_caRx_FInbPJwqP7BSs9I",
  authDomain: "catkitsune-49fda.firebaseapp.com",
  databaseURL: "https://catkitsune-49fda-default-rtdb.firebaseio.com",
  projectId: "catkitsune-49fda",
  storageBucket: "catkitsune-49fda.appspot.com",
  messagingSenderId: "458357499767",
  appId: "1:458357499767:web:b74a26aae203b0a1a24a5"
};

let firebaseApp;
let database;
let firebaseEnabled = false;

try {
  firebaseApp = firebase.initializeApp(firebaseConfig);
  database = firebase.database();
  firebaseEnabled = true;
  console.log('üî• Firebase initialized successfully!');
} catch (error) {
  console.warn('‚ö†Ô∏è Firebase initialization error:', error);
  firebaseEnabled = false;
}

// ==========================================
// VARIABLES
// ==========================================
let walletConnected = false;
let walletAddress = '';
let totalPoints = 0;
let completedCount = 0;
let nftPointsEarned = 0;

const questsLive = false;

// ==========================================
// NFT COLLECTIONS
// ==========================================
const NFT_COLLECTIONS = [
  { 
    name: 'Wealthy Hypo Babies', 
    address: '0x63eb9d77D083cA10C304E28d5191321977fd0Bfb', 
    pointsPerNFT: 1, 
    galleryIndex: 0,
    image: 'https://pbs.twimg.com/profile_images/1876004126938537984/qpRkjcAX_400x400.jpg'
  },
  { 
    name: 'Tiny Hyper Cats', 
    address: '0xCC3D60fF11a268606C6a57bD6Db74b4208f1D30c', 
    pointsPerNFT: 1, 
    galleryIndex: 1,
    image: 'https://static.drip.trade/collections/tiny-hyper-cat_pfp.jpg'
  },
  { 
    name: 'Hypurr', 
    address: '0x9125E2d6827a00B0F8330D6ef7BEF07730Bac685', 
    pointsPerNFT: 1, 
    galleryIndex: 2,
    image: 'https://static.drip.trade/collections/hypurr_pfp.jpg'
  },
  { 
    name: 'Hyperian Genesis', 
    address: '0xB0F82655F249FC6561A94eB370d41bD24A861A9d', 
    pointsPerNFT: 1, 
    galleryIndex: 3,
    image: 'https://static.drip.trade/collections/hyperian-genesis_pfp.png'
  },
  { 
    name: 'CatKitSune', 
    address: '0x2abF2969E5e9cAAa1D3fF3DF4265dFFcda0D8353', 
    pointsPerNFT: 1, 
    galleryIndex: 4,
    image: 'https://static.drip.trade/collections/catkitsune_pfp.png'
  },
  { 
    name: 'Illumeownati by Catbal', 
    address: '0xDdaB956F9EeE629510B4410627cd63C0448A78aB', 
    pointsPerNFT: 1, 
    galleryIndex: 5,
    image: 'https://static.drip.trade/collections/illumeownati_pfp.png'
  },
  { 
    name: 'PiP & Friends', 
    address: '0xbc4a26ba78ce05E8bCbF069Bbb87FB3E1dAC8DF8', 
    pointsPerNFT: 1, 
    galleryIndex: 6,
    image: 'https://static.drip.trade/collections/pip_pfp.jpg'
  },
  { 
    name: 'Hypers', 
    address: '0x8A3bda085fD13E71FA2851D7a4b4B8af9671c5aB', 
    pointsPerNFT: 1, 
    galleryIndex: 7,
    image: 'https://static.drip.trade/collections/hypers_pfp.png'
  },
  { 
    name: 'Mechacats', 
    address: '0xeA8Cc2a7da4E91c559514B8192eF1cfe1497AC74', 
    pointsPerNFT: 1, 
    galleryIndex: 8,
    image: 'https://static.drip.trade/collections/mechacats_pfp.png'
  },
  { 
    name: 'LQnians', 
    address: '0xfD43e36a9D4002C54a84DAB089a2EdE92ffB5C60', 
    pointsPerNFT: 1, 
    galleryIndex: 9,
    image: 'https://static.drip.trade/collections/lqna_pfp.png'
  },
  { 
    name: 'bald br√∂thers', 
    address: '0x7d87FfB185Fc27Cbee62468A9b5eA00d538b74A6', 
    pointsPerNFT: 1, 
    galleryIndex: 10,
    image: 'https://static.drip.trade/collections/bald-brothers_pfp.png'
  },
  { 
    name: 'BAE', 
    address: '0x31ce9E3Fd78B593c2F37f62AE0fa72A23a2472df', 
    pointsPerNFT: 1, 
    galleryIndex: 11,
    image: 'https://static.drip.trade/collections/bae_pfp.png'
  },
  { 
    name: 'Hypo', 
    address: '0x9583b5632372F50e949361df977464D619b2f826', 
    pointsPerNFT: 1, 
    galleryIndex: 12,
    image: 'https://static.drip.trade/collections/hypo_pfp.png'
  },
  { 
    name: 'Hyperian Legacy', 
    address: '0x05fC042966C40f6cA96e226221B4c699593f4645', 
    pointsPerNFT: 1, 
    galleryIndex: 13,
    image: 'https://static.drip.trade/collections/hyperian-legacy_pfp.png'
  },
  { 
    name: 'Odd Otties', 
    address: '0x43A9652E2B3cE8970e8d33d8C34252a59a6596Aa', 
    pointsPerNFT: 1, 
    galleryIndex: 14,
    image: 'https://static.drip.trade/collections/odd-otties_pfp.png'
  },
  { 
    name: 'Purrtardio', 
    address: '0xa5E817BFF8cAd1aeF7767C5eDFA70F9D267A08aA', 
    pointsPerNFT: 1, 
    galleryIndex: 15,
    image: 'https://static.drip.trade/collections/purrtardio_pfp.png'
  },
  { 
    name: 'Gems', 
    address: '0xDD59aC38cb15F688c18909bA1Ca708A76cC351F5', 
    pointsPerNFT: 1, 
    galleryIndex: 16,
    image: 'https://static.drip.trade/collections/gems_pfp.png'
  },
  { 
    name: 'HyperPunks', 
    address: '0xcB8ff875e8e3e7dbc373171c41946cD8Af5aa00f', 
    pointsPerNFT: 1, 
    galleryIndex: 17,
    image: 'https://static.drip.trade/collections/hyperpunks_pfp.png'
  },
  { 
    name: 'dotHYPE', 
    address: '0xBf7cE65e6E920052C11690a80EAa3ed2fE752Dd8', 
    pointsPerNFT: 1, 
    galleryIndex: 18,
    image: 'https://static.drip.trade/collections/dothype_pfp.jpeg'
  },
  { 
    name: 'Dysto Mfers', 
    address: '0x4C3f38129b171f02167d05E72a2994810b42f2Aa', 
    pointsPerNFT: 1, 
    galleryIndex: 19,
    image: 'https://static.drip.trade/collections/dysto-mfers_pfp.jpg'
  }
];

const HYPERLIQUID_RPC = 'https://rpc.hyperliquid.xyz/evm';
const ERC721_ABI = [
  'function balanceOf(address owner) view returns (uint256)',
  'function tokenURI(uint256 tokenId) view returns (string)',
  'function tokenOfOwnerByIndex(address owner, uint256 index) view returns (uint256)'
];

// ==========================================
// STAKING VARIABLES
// ==========================================
let stakedNFTs = {
  series1: [null, null, null, null, null],
  series2: [null, null, null, null, null],
  series3: [null, null, null, null, null]
};

let currentStakingSlot = { series: null, slot: null };
let selectedNFTForStaking = null;

const MAX_NFTS_PER_SERIES = 5;

function getSeriesFromTokenId(tokenId) {
  const id = parseInt(tokenId);
  if (id >= 1 && id <= 100) return 1;
  if (id >= 101 && id <= 200) return 2;
  if (id >= 201 && id <= 300) return 3;
  return null;
}

// ==========================================
// VIEW SWITCHING
// ==========================================
function showView(event, viewName) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.top-nav-btn').forEach(btn => btn.classList.remove('active'));
  document.getElementById('view-' + viewName).classList.add('active');
  if (event && event.target) event.target.classList.add('active');
  
  if (viewName === 'staking') {
    setTimeout(() => updateStakingUI(), 50);
  }
  
  window.scrollTo({ top: 0, behavior: 'smooth' });
}
// Override the head version with this better one
window.showView = showView;
console.log('‚úÖ Full showView loaded (with staking support)');

// ==========================================
// WALLET CONNECTION
// ==========================================
async function connectWallet() {
  if (typeof window.ethereum === 'undefined') {
    alert('ü¶ä Please install MetaMask!\n\nDownload: https://metamask.io');
    window.open('https://metamask.io/download/', '_blank');
    return;
  }
  
  try {
    console.log('üîó Requesting wallet connection...');
    
    const accounts = await window.ethereum.request({ 
      method: 'eth_requestAccounts' 
    });
    
    if (accounts.length === 0) {
      showNotification('‚ùå No wallet selected!');
      return;
    }
    
    walletAddress = accounts[0];
    walletConnected = true;
    updateWalletButton();
    loadUserPoints();
    loadNFTData();
    loadStakingData();
    showNotification('‚úÖ Wallet connected!');
    
    console.log('‚úÖ Wallet connected:', walletAddress);
    
    showNotification('üîç Checking NFT balances...');
    await checkNFTBalances();
  } catch (error) {
    console.error('‚ùå Wallet connection error:', error);
    if (error.code === 4001) {
      showNotification('‚ùå Connection rejected');
    } else {
      showNotification('‚ùå Error: ' + error.message);
    }
  }
}

function disconnectWallet() {
  walletConnected = false;
  walletAddress = '';
  document.getElementById('walletText').textContent = 'Connect Wallet';
  document.getElementById('walletBtn').style.background = '#f9fafb';
  document.getElementById('walletBtn').style.borderColor = '#e5e7eb';
  sessionStorage.removeItem('wallet_address');
  showNotification('üëã Wallet disconnected');
}

function updateWalletButton() {
  const shortAddress = walletAddress.slice(0, 6) + '...' + walletAddress.slice(-4);
  document.getElementById('walletText').textContent = shortAddress;
  document.getElementById('walletBtn').style.background = 'linear-gradient(135deg, #e2d6ff, #d6f5e3)';
  document.getElementById('walletBtn').style.borderColor = '#6a3df5';
  sessionStorage.setItem('wallet_address', walletAddress);
}

function toggleWallet() {
  if (walletConnected) {
    if (confirm('üîå Disconnect wallet?')) disconnectWallet();
  } else {
    connectWallet();
  }
}
window.toggleWallet = toggleWallet;
console.log('‚úÖ toggleWallet loaded');

// ==========================================
// TWITTER LOGIN
// ==========================================
function loginWithTwitter() {
  window.location.href = "https://catkitsune.xyz/api/twitter-login";
}
window.loginWithTwitter = loginWithTwitter;
console.log('‚úÖ loginWithTwitter loaded');

async function loadTwitterUser() {
  const urlParams = new URLSearchParams(window.location.search);
  const name = urlParams.get('name');
  const username = urlParams.get('username');
  const avatar = urlParams.get('avatar');
  
  if (username && avatar) {
    const decodedAvatar = decodeURIComponent(avatar);
    const decodedUsername = decodeURIComponent(username);
    const decodedName = name ? decodeURIComponent(name) : decodedUsername;
    
    document.getElementById('twitterBtn').style.display = 'none';
    const av = document.getElementById('twitterAvatar');
    av.innerHTML = `
      <img src="${decodedAvatar}" style="width:30px;height:30px;border-radius:50%;border:2px solid #1da1f2;">
      <span style="font-weight:600;">@${decodedUsername}</span>
    `;
    av.style.display = 'flex';
    
    sessionStorage.setItem('twitter_user', JSON.stringify({
      name: decodedName,
      username: decodedUsername,
      avatar: decodedAvatar
    }));
    
    showNotification(`üê¶ Logged in as @${decodedUsername}`);
    console.log('‚úÖ Twitter OAuth success:', decodedUsername);
    
    window.history.replaceState({}, document.title, window.location.pathname);
    return;
  }
  
  const savedUser = sessionStorage.getItem('twitter_user');
  if (savedUser) {
    try {
      const user = JSON.parse(savedUser);
      document.getElementById('twitterBtn').style.display = 'none';
      const av = document.getElementById('twitterAvatar');
      av.innerHTML = `
        <img src="${user.avatar}" style="width:30px;height:30px;border-radius:50%;border:2px solid #1da1f2;">
        <span style="font-weight:600;">@${user.username}</span>
      `;
      av.style.display = 'flex';
      console.log('‚úÖ Loaded saved Twitter user:', user.username);
    } catch (e) {
      console.error('Error loading Twitter user:', e);
    }
  }
}

// ==========================================
// NOTIFICATIONS
// ==========================================
function showNotification(message) {
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed; top: 80px; right: 20px;
    background: linear-gradient(135deg, #6a3df5, #22c55e);
    color: white; padding: 12px 20px; border-radius: 12px;
    font-weight: 600; font-size: 14px; z-index: 1000;
    box-shadow: 0 10px 30px rgba(106, 61, 245, 0.3);
  `;
  notification.textContent = message;
  document.body.appendChild(notification);
  setTimeout(() => notification.remove(), 3000);
}

// ==========================================
// USER POINTS SAVE/LOAD
// ==========================================
function saveUserPoints() {
  if (!walletAddress) return;
  
  const userDataKey = `user_points_${walletAddress}`;
  const userData = {
    address: walletAddress,
    totalPoints: totalPoints,
    completedQuests: completedCount,
    lastUpdated: Date.now()
  };
  
  localStorage.setItem(userDataKey, JSON.stringify(userData));
  console.log(`üíæ Points saved locally for ${walletAddress}: ${totalPoints} EP`);
  
  if (firebaseEnabled && database) {
    const userRef = database.ref('users/' + walletAddress);
    userRef.set({
      address: walletAddress,
      points: totalPoints,
      completedQuests: completedCount,
      lastUpdated: Date.now()
    }).then(() => {
      console.log(`üî• Points synced to Firebase: ${totalPoints} EP`);
    }).catch((error) => {
      console.error('‚ùå Firebase sync error:', error);
    });
  }
}

async function loadUserPoints() {
  if (!walletAddress) return;
  
  const userDataKey = `user_points_${walletAddress}`;
  
  if (firebaseEnabled && database) {
    try {
      const userRef = database.ref('users/' + walletAddress);
      const snapshot = await userRef.once('value');
      
      if (snapshot.exists()) {
        const userData = snapshot.val();
        totalPoints = userData.points || 0;
        completedCount = userData.completedQuests || 0;
        
        console.log(`üî• Points loaded from Firebase: ${totalPoints} EP`);
        
        localStorage.setItem(userDataKey, JSON.stringify({
          address: walletAddress,
          totalPoints: totalPoints,
          completedQuests: completedCount,
          lastUpdated: Date.now()
        }));
        
        return;
      }
    } catch (error) {
      console.error('‚ùå Firebase load error:', error);
    }
  }
  
  const savedData = localStorage.getItem(userDataKey);
  
  if (savedData) {
    try {
      const userData = JSON.parse(savedData);
      totalPoints = userData.totalPoints || 0;
      completedCount = userData.completedQuests || 0;
      
      console.log(`üìÇ Points loaded from localStorage: ${totalPoints} EP`);
    } catch (e) {
      console.error('Error loading user points:', e);
    }
  }
}

// ==========================================
// NFT BALANCE CHECK
// ==========================================
async function fetchNFTImage(contract, tokenId) {
  try {
    const tokenURI = await contract.tokenURI(tokenId);
    
    let metadataURL = tokenURI;
    if (tokenURI.startsWith('ipfs://')) {
      metadataURL = tokenURI.replace('ipfs://', 'https://ipfs.io/ipfs/');
    }
    
    const response = await fetch(metadataURL);
    const metadata = await response.json();
    
    let imageURL = metadata.image || metadata.image_url;
    if (imageURL && imageURL.startsWith('ipfs://')) {
      imageURL = imageURL.replace('ipfs://', 'https://ipfs.io/ipfs/');
    }
    
    return imageURL;
  } catch (error) {
    console.error('Error fetching NFT image:', error);
    return null;
  }
}

async function checkNFTBalances() {
  if (!walletConnected || !walletAddress) {
    console.log('‚ùå Wallet not connected');
    return;
  }
  
  if (typeof ethers === 'undefined') {
    console.error('‚ùå Ethers.js not loaded!');
    showNotification('‚ùå Web3 library error');
    return;
  }
  
  console.log('üîç Checking NFTs:', walletAddress);
  
  try {
    const provider = new ethers.providers.JsonRpcProvider(HYPERLIQUID_RPC);
    const network = await provider.getNetwork();
    console.log('‚úÖ Connected:', network.name);
    
    let totalNFTs = 0;
    
    for (const collection of NFT_COLLECTIONS) {
      try {
        console.log(`üì¶ ${collection.name}...`);
        const contract = new ethers.Contract(collection.address, ERC721_ABI, provider);
        const balance = await contract.balanceOf(walletAddress);
        const balanceNum = balance.toNumber();
        
        console.log(`‚úÖ ${collection.name}: ${balanceNum}`);
        
        const nftCardContainer = document.querySelector(`[data-nft-index="${collection.galleryIndex}"]`);
        const nftElement = document.getElementById(`nft-${collection.galleryIndex}`);
        
        if (nftCardContainer && nftElement) {
          nftCardContainer.style.display = 'flex';
          
          nftElement.textContent = `${balanceNum} owned`;
          
          const nftCard = nftCardContainer.querySelector('.nft-card');
          
          if (balanceNum > 0) {
            nftElement.style.color = '#16a34a';
            nftElement.style.fontWeight = '600';
            
            let nftImageURL = collection.image;
            
            try {
              const tokenId = await contract.tokenOfOwnerByIndex(walletAddress, 0);
              console.log(`üñºÔ∏è Fetching image for token #${tokenId}...`);
              
              const realImage = await fetchNFTImage(contract, tokenId);
              if (realImage) {
                nftImageURL = realImage;
                console.log(`‚úÖ Got real image: ${realImage.substring(0, 50)}...`);
              }
            } catch (e) {
              console.log(`‚ö†Ô∏è Could not fetch real image, using placeholder`);
            }
            
            let img = nftCard.querySelector('.nft-image');
            if (!img) {
              img = document.createElement('img');
              img.className = 'nft-image';
              img.style.cssText = 'width:100%;height:100%;object-fit:cover;border-radius:10px;position:absolute;top:0;left:0;z-index:0;';
              nftCard.insertBefore(img, nftCard.firstChild);
            }
            img.src = nftImageURL;
            img.alt = collection.name;
            
            img.onerror = () => {
              console.log(`‚ùå Image failed to load, using placeholder`);
              img.src = collection.image;
            };
            
            const strong = nftCard.querySelector('strong');
            if (strong) {
              strong.style.display = 'none';
            }
          } else {
            nftElement.style.color = '#6b7280';
            nftElement.style.fontWeight = '400';
            
            const img = nftCard.querySelector('.nft-image');
            if (img) {
              img.remove();
            }
            
            const strong = nftCard.querySelector('strong');
            if (strong) {
              strong.style.display = 'block';
              strong.style.position = 'relative';
              strong.style.zIndex = '1';
              strong.style.textShadow = 'none';
              strong.style.color = '#111827';
              strong.style.background = 'none';
              strong.style.padding = '0';
            }
          }
        }
        
        totalNFTs += balanceNum;
      } catch (error) {
        console.error(`‚ùå ${collection.name}:`, error.message);
        
        const nftCardContainer = document.querySelector(`[data-nft-index="${collection.galleryIndex}"]`);
        const nftElement = document.getElementById(`nft-${collection.galleryIndex}`);
        if (nftCardContainer && nftElement) {
          nftCardContainer.style.display = 'flex';
          nftElement.textContent = '0 owned';
          nftElement.style.color = '#6b7280';
        }
      }
    }
    
    console.log(`‚úÖ Total: ${totalNFTs} NFTs found`);
    
    saveNFTData();
    
    if (totalNFTs > 0) {
      showNotification(`üéâ ${totalNFTs} NFTs found!`);
    } else {
      showNotification('‚ÑπÔ∏è No NFTs found');
    }
    
  } catch (error) {
    console.error('‚ùå NFT check error:', error);
    showNotification('‚ùå NFT check failed');
  }
}

function saveNFTData() {
  if (!walletAddress) return;
  
  const nftData = {};
  
  for (let i = 0; i < 15; i++) {
    const nftElement = document.getElementById(`nft-${i}`);
    const nftCard = document.querySelector(`[data-nft-index="${i}"]`);
    
    if (nftElement && nftCard) {
      const img = nftCard.querySelector('.nft-image');
      nftData[i] = {
        text: nftElement.textContent,
        color: nftElement.style.color,
        fontWeight: nftElement.style.fontWeight,
        imageUrl: img ? img.src : null
      };
    }
  }
  
  localStorage.setItem(`nft_data_${walletAddress}`, JSON.stringify(nftData));
  console.log(`üíæ NFT data saved for ${walletAddress}`);
}

function loadNFTData() {
  if (!walletAddress) return;
  
  const savedData = localStorage.getItem(`nft_data_${walletAddress}`);
  
  if (!savedData) {
    console.log('üìÇ No saved NFT data found');
    return;
  }
  
  try {
    const nftData = JSON.parse(savedData);
    
    for (let i = 0; i < 15; i++) {
      if (!nftData[i]) continue;
      
      const nftElement = document.getElementById(`nft-${i}`);
      const nftCardContainer = document.querySelector(`[data-nft-index="${i}"]`);
      
      if (nftElement && nftCardContainer) {
        const nftCard = nftCardContainer.querySelector('.nft-card');
        
        nftCardContainer.style.display = 'flex';
        
        nftElement.textContent = nftData[i].text;
        nftElement.style.color = nftData[i].color;
        nftElement.style.fontWeight = nftData[i].fontWeight;
        
        if (nftData[i].imageUrl && nftCard) {
          let img = nftCard.querySelector('.nft-image');
          if (!img) {
            img = document.createElement('img');
            img.className = 'nft-image';
            img.style.cssText = 'width:100%;height:100%;object-fit:cover;border-radius:10px;position:absolute;top:0;left:0;z-index:0;';
            nftCard.insertBefore(img, nftCard.firstChild);
          }
          img.src = nftData[i].imageUrl;
          
          const strong = nftCard.querySelector('strong');
          if (strong) {
            strong.style.display = 'none';
          }
        } else {
          const strong = nftCard.querySelector('strong');
          if (strong) {
            strong.style.display = 'block';
          }
        }
      }
    }
    
    console.log(`üìÇ NFT data loaded for ${walletAddress}`);
  } catch (e) {
    console.error('Error loading NFT data:', e);
  }
}

// ==========================================
// NFT STAKING MODAL
// ==========================================
async function openNFTModal(seriesNumber, slotIndex) {
  if (!walletConnected) {
    showNotification('‚ö†Ô∏è Please connect wallet first!');
    return;
  }
  
  const seriesKey = `series${seriesNumber}`;
  
  // Check if slot is already filled
  if (stakedNFTs[seriesKey][slotIndex] !== null) {
    showNotification('‚ö†Ô∏è Slot is already filled! Use the X button to unstake.');
    return;
  }
  
  // Store current slot info
  currentStakingSlot = { series: seriesNumber, slot: slotIndex };
  selectedNFTForStaking = null;
  
  // Get user's NFTs from this series
  const CATKITSUNE_CONTRACT = '0x2abF2969E5e9cAAa1D3fF3DF4265dFFcda0D8353';
  const provider = new ethers.providers.Web3Provider(window.ethereum);
  let seriesNFTs = [];
  
  try {
    const collection = NFT_COLLECTIONS.find(c => c.address.toLowerCase() === CATKITSUNE_CONTRACT.toLowerCase());
    
    if (!collection) {
      showNotification('‚ùå CatKitSune contract not found!');
      return;
    }
    
    const contract = new ethers.Contract(collection.address, ERC721_ABI, provider);
    const balance = await contract.balanceOf(walletAddress);
    
    console.log(`üîç Checking wallet ${walletAddress} for CatKitSune NFTs...`);
    console.log(`üìä Balance: ${balance.toString()} NFTs found`);
    
    for (let i = 0; i < balance; i++) {
      const tokenId = await contract.tokenOfOwnerByIndex(walletAddress, i);
      const series = getSeriesFromTokenId(tokenId.toString());
      
      console.log(`‚úÖ Found NFT #${tokenId.toString()} - Series ${series}`);
      
      // Check if this NFT is already staked in any slot
      const isStaked = stakedNFTs[seriesKey].some(nft => nft && nft.tokenId === tokenId.toString());
      
      if (series === seriesNumber && !isStaked) {
        // Try to fetch NFT image
        let nftImage = collection.image;
        try {
          const realImage = await fetchNFTImage(contract, tokenId);
          if (realImage) nftImage = realImage;
        } catch (e) {
          console.log('Could not fetch NFT image');
        }
        
        seriesNFTs.push({
          contract: collection.address,
          tokenId: tokenId.toString(),
          collection: collection.name,
          series: series,
          image: nftImage
        });
      }
    }
    
    // Show modal with NFT list
    const modalList = document.getElementById('modalNFTList');
    const confirmBtn = document.getElementById('confirmStakeBtn');
    
    if (seriesNFTs.length === 0) {
      modalList.innerHTML = `
        <div class="modal-empty">
          <div class="modal-empty-icon">ü¶ä</div>
          <div class="modal-empty-text">No available NFTs</div>
          <div class="modal-empty-subtext">You don't have any Series ${seriesNumber} NFTs available to stake.</div>
        </div>
      `;
      confirmBtn.disabled = true;
    } else {
      modalList.innerHTML = `
        <div class="nft-selection-grid">
          ${seriesNFTs.map((nft, index) => `
            <div class="nft-select-card" data-nft-index="${index}" onclick="selectNFTForStaking(${index})">
              <img src="${nft.image}" class="nft-select-img" alt="NFT #${nft.tokenId}">
              <div class="nft-select-id">NFT #${nft.tokenId}</div>
              <div class="nft-select-series">Series ${nft.series}</div>
            </div>
          `).join('')}
        </div>
      `;
      confirmBtn.disabled = true;
    }
    
    // Store NFTs for later use
    window.availableNFTsForStaking = seriesNFTs;
    
    // Show modal
    document.getElementById('nftModal').classList.add('active');
    
  } catch (error) {
    console.error('‚ùå Error loading NFTs:', error);
    showNotification(`‚ùå Error: ${error.message}`);
  }
}

function selectNFTForStaking(index) {
  // Remove previous selection
  document.querySelectorAll('.nft-select-card').forEach(card => {
    card.classList.remove('selected');
  });
  
  // Add selection to clicked card
  const selectedCard = document.querySelector(`[data-nft-index="${index}"]`);
  if (selectedCard) {
    selectedCard.classList.add('selected');
    selectedNFTForStaking = window.availableNFTsForStaking[index];
    document.getElementById('confirmStakeBtn').disabled = false;
  }
}

function closeNFTModal() {
  document.getElementById('nftModal').classList.remove('active');
  selectedNFTForStaking = null;
  currentStakingSlot = { series: null, slot: null };
}

function confirmStake() {
  if (!selectedNFTForStaking || !currentStakingSlot.series) {
    showNotification('‚ö†Ô∏è Please select an NFT first!');
    return;
  }
  
  const { series, slot } = currentStakingSlot;
  const seriesKey = `series${series}`;
  
  console.log(`üéØ Staking NFT #${selectedNFTForStaking.tokenId} to Series ${series}, Slot ${slot}`);
  
  // Stake the NFT to the slot
  stakedNFTs[seriesKey][slot] = selectedNFTForStaking;
  
  // Award EP points
  const epEarned = 5;
  totalPoints += epEarned;
  nftPointsEarned += epEarned;
  
  console.log(`üí∞ Awarded ${epEarned} EP. Total: ${totalPoints} EP`);
  
  saveStakingData();
  saveUserPoints();
  updateStakingUI();
  
  closeNFTModal();
  
  showNotification(`üéâ NFT #${selectedNFTForStaking.tokenId} staked to Series ${series}! +${epEarned} EP earned!`);
}

// ==========================================
// STAKING DATA MANAGEMENT
// ==========================================
function loadStakingData() {
  if (!walletAddress) return;
  
  const saved = localStorage.getItem(`staking_${walletAddress}`);
  if (saved) {
    try {
      stakedNFTs = JSON.parse(saved);
      
      // Calculate EP from staked NFTs
      nftPointsEarned = 0;
      Object.keys(stakedNFTs).forEach(seriesKey => {
        const stakedCount = stakedNFTs[seriesKey].filter(nft => nft !== null).length;
        nftPointsEarned += stakedCount * 5;
      });
      
      console.log(`üìÇ Loaded staking data: ${nftPointsEarned} EP from staking`);
      updateStakingUI();
    } catch (e) {
      console.error('Error loading staking data:', e);
    }
  }
}

function saveStakingData() {
  if (!walletAddress) return;
  localStorage.setItem(`staking_${walletAddress}`, JSON.stringify(stakedNFTs));
  console.log('üíæ Staking data saved');
}

function unstakeFromSlot(seriesNumber, slotIndex) {
  const seriesKey = `series${seriesNumber}`;
  
  if (!stakedNFTs[seriesKey][slotIndex]) return;
  
  const nft = stakedNFTs[seriesKey][slotIndex];
  console.log(`üîì Unstaking NFT #${nft.tokenId} from Series ${seriesNumber}, Slot ${slotIndex}`);
  
  // Remove NFT from slot
  stakedNFTs[seriesKey][slotIndex] = null;
  
  // Remove EP points
  const epLost = 5;
  totalPoints -= epLost;
  nftPointsEarned -= epLost;
  
  if (totalPoints < 0) totalPoints = 0;
  if (nftPointsEarned < 0) nftPointsEarned = 0;
  
  saveStakingData();
  saveUserPoints();
  updateStakingUI();
  
  showNotification(`‚úÖ NFT #${nft.tokenId} unstaked from Series ${seriesNumber}!`);
}

function updateStakingUI() {
  // Update total staked count
  let totalStaked = 0;
  totalStaked += stakedNFTs.series1.filter(nft => nft !== null).length;
  totalStaked += stakedNFTs.series2.filter(nft => nft !== null).length;
  totalStaked += stakedNFTs.series3.filter(nft => nft !== null).length;
  
  const totalStakedEl = document.getElementById('totalStaked');
  if (totalStakedEl) totalStakedEl.textContent = `${totalStaked}/15`;
  
  // Update total EP from staking
  const totalStakingEP = document.getElementById('totalStakingEP');
  if (totalStakingEP) totalStakingEP.textContent = nftPointsEarned || 0;
  
  // Update each series
  for (let seriesNum = 1; seriesNum <= 3; seriesNum++) {
    const seriesKey = `series${seriesNum}`;
    const nfts = stakedNFTs[seriesKey] || [];
    const countEl = document.getElementById(`${seriesKey}-count`);
    
    // Update count
    const stakedCount = nfts.filter(nft => nft !== null).length;
    if (countEl) {
      countEl.textContent = `(${stakedCount}/${MAX_NFTS_PER_SERIES})`;
    }
    
    // Update each slot
    for (let slotIndex = 0; slotIndex < MAX_NFTS_PER_SERIES; slotIndex++) {
      const slotEl = document.getElementById(`series${seriesNum}-slot${slotIndex}`);
      const nft = nfts[slotIndex];
      
      if (!slotEl) continue;
      
      if (!nft) {
        // Empty slot
        const imagePaths = [
          '/launch/1.png',
          '/launch/2.png',
          '/launch/3.png',
          '/launch/4.png',
          '/launch/5.png'
        ];
        
        slotEl.style.background = 'white';
        slotEl.style.border = '2px solid var(--primary)';
        slotEl.style.cursor = 'pointer';
        slotEl.innerHTML = `
          <img src="${imagePaths[slotIndex]}" class="nft-slot-image" alt="CatKitSune NFT" style="width:100%; height:100%; object-fit:cover; position:absolute; top:0; left:0; opacity:0.4; transition:opacity 0.3s ease; border-radius:12px;">
          <div class="slot-overlay" style="position:relative; z-index:2; display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; min-height:180px; padding:16px; background:linear-gradient(135deg, rgba(20, 184, 166, 0.05), rgba(139, 92, 246, 0.05));">
            <div style="font-size:14px; color:var(--primary); font-weight:700; text-align:center; text-shadow:0 2px 4px rgba(255,255,255,0.8);">+ Add NFT</div>
            <div style="font-size:11px; color:var(--text-muted); text-align:center; margin-top:4px; text-shadow:0 1px 2px rgba(255,255,255,0.8);">Click to stake</div>
          </div>
        `;
        
        slotEl.onclick = function() {
          openNFTModal(seriesNum, slotIndex);
        };
      } else {
        // Filled slot
        slotEl.style.background = 'linear-gradient(135deg, var(--primary), #8b5cf6)';
        slotEl.style.border = '2px solid var(--primary)';
        slotEl.style.cursor = 'default';
        slotEl.onclick = null;
        slotEl.innerHTML = `
          <div style="position:relative; width:100%; height:100%;">
            <button onclick="event.stopPropagation(); unstakeFromSlot(${seriesNum}, ${slotIndex})" style="position:absolute; top:-8px; right:-8px; background:#ef4444; color:white; border:none; border-radius:50%; width:28px; height:28px; cursor:pointer; font-size:16px; font-weight:700; display:flex; align-items:center; justify-content:center; z-index:10; box-shadow:0 2px 4px rgba(0,0,0,0.2);">√ó</button>
            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:white;">
              <div style="font-size:32px; margin-bottom:8px;">ü¶ä</div>
              <div style="font-weight:700; font-size:13px;">#${nft.tokenId}</div>
              <div style="font-size:11px; opacity:0.9;">+5 EP</div>
            </div>
          </div>
        `;
      }
    }
  }
}

// ==========================================
// INIT
// ==========================================
window.onload = async function() {
  console.log('üöÄ CatKitSune loading...');
  loadTwitterUser();
  
  const savedWallet = sessionStorage.getItem('wallet_address');
  if (savedWallet && typeof window.ethereum !== 'undefined') {
    walletAddress = savedWallet;
    walletConnected = true;
    updateWalletButton();
    loadUserPoints();
    loadNFTData();
    loadStakingData();
    
    // ‚úÖ Check NFT balances when page loads with connected wallet
    console.log('üîç Refreshing NFT balances...');
    await checkNFTBalances();
  }
  
  updateStakingUI();
  
  console.log('‚úÖ Ready!');
};

if (typeof window.ethereum !== 'undefined') {
  window.ethereum.on('accountsChanged', (accounts) => {
    if (accounts.length === 0) {
      disconnectWallet();
    } else if (walletConnected) {
      walletAddress = accounts[0];
      updateWalletButton();
      loadStakingData();
      showNotification('üîÑ Account changed');
    }
  });
}
</script>
</body>
</html>
