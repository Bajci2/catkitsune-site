<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CatKitSune - Mint NFT</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{--primary:#14b8a6;--primary-dark:#0d9488;--bg-main:#f0fdf9;--text-main:#111827;--text-muted:#6b7280;--border:#e5e7eb}
body{font-family:Inter,sans-serif;background:linear-gradient(135deg,#f0fdf9 0%,#ccfbf1 100%);min-height:100vh;color:var(--text-main)}
.container{max-width:1400px;margin:0 auto;padding:20px}
header{background:rgba(255,255,255,.95);backdrop-filter:blur(10px);border-bottom:1px solid var(--border);padding:16px 0;position:sticky;top:0;z-index:100}
.header-content{max-width:1400px;margin:0 auto;padding:0 20px;display:flex;justify-content:space-between;align-items:center}
.logo{font-size:24px;font-weight:900;background:linear-gradient(135deg,var(--primary),var(--primary-dark));-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-decoration:none}
.back-btn{padding:10px 20px;background:var(--primary);color:#fff;border-radius:12px;text-decoration:none;font-weight:600}
.supply-banner{background:linear-gradient(135deg,#667eea,#764ba2);padding:16px 24px;border-radius:16px;display:flex;justify-content:space-between;align-items:center;margin-bottom:40px}
.supply-count{font-size:32px;font-weight:900;color:#fff}
.progress-bar{height:12px;background:rgba(255,255,255,.2);border-radius:999px;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,#10b981,#22c55e);width:0%;transition:width 0.3s}
.progress-text{color:#fff;font-size:12px;text-align:center;margin-top:4px}
.status-badge{background:rgba(255,255,255,.2);padding:8px 16px;border-radius:999px;color:#fff;font-weight:700}
.mint-section{display:grid;grid-template-columns:1fr 1fr;gap:40px}
.nft-preview,.mint-card{background:#fff;border-radius:24px;padding:32px;box-shadow:0 10px 40px rgba(0,0,0,.1)}
.nft-grid-container{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.nft-grid-item img{width:100%;border-radius:12px;transition:transform 0.2s}
.nft-grid-item img:hover{transform:scale(1.05)}
.mint-button{width:100%;padding:20px;background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;border:none;border-radius:16px;font-size:18px;font-weight:700;cursor:pointer;transition:all 0.3s}
.mint-button:hover:not(:disabled){opacity:0.9;transform:translateY(-2px);box-shadow:0 8px 20px rgba(20,184,166,0.3)}
.mint-button:disabled{opacity:0.5;cursor:not-allowed}
.mint-button.loading{background:linear-gradient(135deg,#f59e0b,#d97706)}
.debug-info{margin-top:20px;padding:16px;background:#f3f4f6;border-radius:12px;font-size:11px;font-family:monospace;max-height:200px;overflow-y:auto;line-height:1.5}
.debug-entry{padding:2px 0;border-bottom:1px solid #e5e7eb}
.debug-entry:last-child{border-bottom:none}
@media (max-width: 768px){
  .mint-section{grid-template-columns:1fr}
}
</style>
</head>

<body>

<header>
  <div class="header-content">
    <a class="logo" href="/">üê± CatKitSune</a>
    <a class="back-btn" href="/">‚Üê Back</a>
  </div>
</header>

<div class="container">

<div class="supply-banner">
  <div>
    <div style="color:#fff;font-size:13px;opacity:0.8">Minted</div>
    <div class="supply-count" id="supplyCount">‚Äì / 300</div>
  </div>
  <div style="flex:1;margin:0 24px">
    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
    <div class="progress-text" id="progressText">Loading‚Ä¶</div>
  </div>
  <div class="status-badge" id="statusBadge">üî• Minting Live</div>
</div>

<div class="mint-section">

<div class="nft-preview">
  <h2 style="margin-bottom:20px;font-size:24px">Preview Collection</h2>
  <div class="nft-grid-container">
    <div class="nft-grid-item"><img src="/launch/1.png" alt="CatKitSune #1"></div>
    <div class="nft-grid-item"><img src="/launch/2.png" alt="CatKitSune #2"></div>
    <div class="nft-grid-item"><img src="/launch/3.png" alt="CatKitSune #3"></div>
    <div class="nft-grid-item"><img src="/launch/4.png" alt="CatKitSune #4"></div>
    <div class="nft-grid-item"><img src="/launch/5.png" alt="CatKitSune #5"></div>
    <div class="nft-grid-item"><img src="/launch/6.png" alt="CatKitSune #6"></div>
    <div class="nft-grid-item"><img src="/launch/7.png" alt="CatKitSune #7"></div>
    <div class="nft-grid-item"><img src="/launch/8.png" alt="CatKitSune #8"></div>
    <div class="nft-grid-item"><img src="/launch/9.png" alt="CatKitSune #9"></div>
  </div>
</div>

<div class="mint-card">
  <h1 style="font-size:32px;margin-bottom:8px">üî• Mint Your NFT</h1>
  <p style="color:var(--text-muted);margin-bottom:24px">Get your unique CatKitSune character!</p>
  <h2 style="margin:20px 0;font-size:36px;color:var(--primary)">0.3 HYPE</h2>
  <button class="mint-button" id="mintBtn" onclick="mint()">
    <span id="btnText">Connect & Mint</span>
  </button>
  <div class="debug-info" id="debugLog">
    <div class="debug-entry">Ready to mint... Click the button to start!</div>
  </div>
</div>

</div>
</div>

<script>
/* ===== CONFIG ===== */
const CONTRACT_ADDRESS = "0x3245FBe8515B8125643337238EB98B6f8a407303";
const RPC_URL = "https://rpc.hyperliquid.xyz/evm";
const CHAIN_ID = "0x3E7"; // 999 in decimal
const MAX_SUPPLY = 300;

// ‚ö†Ô∏è KRITIKUS: A contract require(msg.value == PRICE) haszn√°l, teh√°t PONTOSAN 0.3 ether kell!
const PRICE_ETHER = "0.3";

const ABI = [
  "function mint() payable",
  "function totalMinted() view returns (uint256)"
];

/* ===== DEBUG LOG ===== */
function log(msg, clear = false){
  const debugLog = document.getElementById("debugLog");
  const timestamp = new Date().toLocaleTimeString();
  
  if(clear){
    debugLog.innerHTML = '';
  }
  
  debugLog.innerHTML += `<div class="debug-entry">[${timestamp}] ${msg}</div>`;
  debugLog.scrollTop = debugLog.scrollHeight;
  console.log(`[${timestamp}] ${msg}`);
}

/* ===== SUPPLY ===== */
async function updateSupply(){
  try {
    const provider = new ethers.providers.JsonRpcProvider(RPC_URL);
    const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);

    const minted = (await contract.totalMinted()).toNumber();
    const remaining = MAX_SUPPLY - minted;
    const percent = Math.floor((minted / MAX_SUPPLY) * 100);

    document.getElementById("supplyCount").innerText = `${minted} / ${MAX_SUPPLY}`;
    document.getElementById("progressFill").style.width = percent + "%";
    document.getElementById("progressText").innerText = `${remaining} remaining`;

    if(remaining <= 0){
      document.getElementById("statusBadge").innerText = "SOLD OUT";
      document.getElementById("statusBadge").style.background = "rgba(239,68,68,0.3)";
      document.getElementById("mintBtn").disabled = true;
      document.getElementById("btnText").innerText = "Sold Out";
    }
    
    log(`‚úÖ Supply updated: ${minted}/${MAX_SUPPLY}`);
  } catch(e) {
    log(`‚ö†Ô∏è Supply check error: ${e.message}`);
  }
}

updateSupply();
setInterval(updateSupply, 10000);

/* ===== MINT ===== */
async function mint(){
  const btn = document.getElementById("mintBtn");
  const btnText = document.getElementById("btnText");
  
  btn.disabled = true;
  btn.classList.add('loading');
  btnText.innerText = "Connecting...";
  
  log("üöÄ Mint process started", true);
  
  if(!window.ethereum){
    alert("‚ùå Please install MetaMask to mint NFTs");
    log("‚ùå MetaMask not detected");
    btn.disabled = false;
    btn.classList.remove('loading');
    btnText.innerText = "Connect & Mint";
    return;
  }

  try {
    const provider = new ethers.providers.Web3Provider(window.ethereum);
    log("‚úÖ Web3 provider created");
    
    // Request account access
    btnText.innerText = "Approve in MetaMask...";
    await provider.send("eth_requestAccounts", []);
    log("‚úÖ Account access granted");
    
    const signer = provider.getSigner();
    const address = await signer.getAddress();
    log(`‚úÖ Connected wallet: ${address.substring(0, 10)}...`);

    // Check network
    const chainId = await provider.send("eth_chainId", []);
    log(`üîó Current chain: ${parseInt(chainId, 16)} (need: 999)`);
    
    if(chainId !== CHAIN_ID){
      log("‚ö†Ô∏è Wrong network detected, switching...");
      btnText.innerText = "Switch Network...";
      
      try{
        await window.ethereum.request({
          method: "wallet_switchEthereumChain",
          params: [{ chainId: CHAIN_ID }]
        });
        log("‚úÖ Network switched to HyperEVM");
      }catch(switchError){
        log(`‚ùå Network switch failed: ${switchError.message}`);
        alert("‚ùå Please switch to HyperEVM network (Chain ID: 999) in MetaMask");
        btn.disabled = false;
        btn.classList.remove('loading');
        btnText.innerText = "Connect & Mint";
        return;
      }
    }

    // Check balance
    const balance = await signer.getBalance();
    const balanceHYPE = parseFloat(ethers.utils.formatEther(balance)).toFixed(4);
    log(`üí∞ Wallet balance: ${balanceHYPE} HYPE`);
    
    if(balance.lt(ethers.utils.parseEther(PRICE_ETHER))){
      alert(`‚ùå Insufficient balance!\n\nYou have: ${balanceHYPE} HYPE\nNeed: ${PRICE_ETHER} HYPE`);
      log("‚ùå Insufficient balance for minting");
      btn.disabled = false;
      btn.classList.remove('loading');
      btnText.innerText = "Connect & Mint";
      return;
    }

    const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
    log("‚úÖ Contract instance created");
    
    // Gas estimation
    btnText.innerText = "Estimating Gas...";
    log("‚õΩ Estimating gas cost...");
    
    let gasEstimate;
    try {
      // KRITIKUS: Pontosan 0.3 ether-t k√ºld√ºnk, ahogy a contract require-je k√©ri
      gasEstimate = await contract.estimateGas.mint({
        value: ethers.utils.parseEther(PRICE_ETHER)
      });
      log(`‚úÖ Gas estimate: ${gasEstimate.toString()} units`);
    } catch(gasError) {
      log(`‚ùå Gas estimation failed: ${gasError.message}`);
      console.error("Gas error details:", gasError);
      
      let errorMsg = "‚ùå Minting failed. Possible reasons:\n\n";
      
      if(gasError.message.includes("Wrong price")){
        errorMsg += "‚Ä¢ Incorrect price sent to contract\n";
      } else if(gasError.message.includes("Sold out")){
        errorMsg += "‚Ä¢ All NFTs have been minted\n";
      } else {
        errorMsg += "‚Ä¢ Contract may have an issue\n";
        errorMsg += "‚Ä¢ Check console for details\n";
      }
      
      alert(errorMsg);
      btn.disabled = false;
      btn.classList.remove('loading');
      btnText.innerText = "Connect & Mint";
      return;
    }

    // Send transaction
    btnText.innerText = "Minting... Approve in MetaMask";
    log("üì§ Sending mint transaction...");
    
    const tx = await contract.mint({
      value: ethers.utils.parseEther(PRICE_ETHER),
      gasLimit: gasEstimate.mul(120).div(100) // 20% buffer for safety
    });
    
    log(`‚úÖ Transaction sent: ${tx.hash}`);
    btnText.innerText = "Waiting for Confirmation...";
    
    // Wait for confirmation
    log("‚è≥ Waiting for blockchain confirmation...");
    const receipt = await tx.wait();
    
    log(`‚úÖ Transaction confirmed! Block: ${receipt.blockNumber}`);
    log(`üéâ NFT Successfully Minted!`);
    
    // Update supply immediately
    await updateSupply();
    
    // Success message
    alert(`üéâ NFT SUCCESSFULLY MINTED!\n\nTransaction: ${tx.hash}\n\nYour NFT will appear in your wallet shortly!`);
    
    btnText.innerText = "Mint Another";
    
  }catch(e){
    log(`‚ùå Error: ${e.message}`);
    console.error("Full error:", e);
    
    let errorMsg = "‚ùå Minting failed:\n\n";
    
    if(e.code === 4001){
      errorMsg += "Transaction was rejected in MetaMask";
    } else if(e.code === -32603){
      errorMsg += "Internal error occurred";
    } else if(e.message.includes("insufficient funds")){
      errorMsg += "Insufficient funds for gas fee";
    } else if(e.message.includes("Wrong price")){
      errorMsg += "Incorrect price sent (need exactly 0.3 HYPE)";
    } else if(e.message.includes("Sold out")){
      errorMsg += "All NFTs have been minted!";
    } else {
      errorMsg += e.message || "Unknown error occurred";
    }
    
    alert(errorMsg);
    btnText.innerText = "Try Again";
    
  } finally {
    btn.disabled = false;
    btn.classList.remove('loading');
  }
}
</script>

</body>
</html>
